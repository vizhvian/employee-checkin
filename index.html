<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>üìç Employee Check-in</title>
    
    <!-- PWA Manifest -->
    <link rel="manifest" href="data:application/manifest+json,{
        'name': 'Employee Check-in',
        'short_name': 'Check-in',
        'description': 'Employee location-based check-in system',
        'start_url': '/',
        'display': 'standalone',
        'background_color': '#ffffff',
        'theme_color': '#4f46e5',
        'icons': [
            {
                'src': 'data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iNTEyIiBoZWlnaHQ9IjUxMiIgdmlld0JveD0iMCAwIDUxMiA1MTIiIGZpbGw9Im5vbmUiIHhtbG5zPSJodHRwOi8vd3d3LnczLm9yZy8yMDAwL3N2ZyI+CjxjaXJjbGUgY3g9IjI1NiIgY3k9IjI1NiIgcj0iMjU2IiBmaWxsPSIjNGY0NmU1Ii8+Cjx0ZXh0IHg9IjI1NiIgeT0iMzAwIiB0ZXh0LWFuY2hvcj0ibWlkZGxlIiBmb250LXNpemU9IjE4MCIgZmlsbD0id2hpdGUiPvCfk40gPC90ZXh0Pgo8L3N2Zz4K',
                'sizes': '512x512',
                'type': 'image/svg+xml'
            }
        ]
    }">
    
    <style>
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
            color: #333;
        }

        .container {
            background: white;
            padding: 2rem;
            border-radius: 20px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.1);
            max-width: 400px;
            width: 90%;
            text-align: center;
        }

        h1 {
            font-size: 1.8rem;
            margin-bottom: 1.5rem;
            color: #4f46e5;
        }

        .form-group {
            margin-bottom: 1rem;
            text-align: left;
        }

        label {
            display: block;
            margin-bottom: 0.5rem;
            color: #374151;
            font-weight: 600;
        }

        input[type="text"], input[type="password"] {
            width: 100%;
            padding: 0.75rem;
            border: 2px solid #e5e7eb;
            border-radius: 8px;
            font-size: 1rem;
            transition: border-color 0.3s;
        }

        input[type="text"]:focus, input[type="password"]:focus {
            outline: none;
            border-color: #4f46e5;
        }

        .status-card {
            background: #f8fafc;
            padding: 1.5rem;
            border-radius: 15px;
            margin: 1.5rem 0;
            border-left: 4px solid #4f46e5;
        }

        .user-info {
            background: #ecfdf5;
            padding: 1rem;
            border-radius: 10px;
            margin: 1rem 0;
            border-left: 4px solid #10b981;
            text-align: left;
        }

        .location-info {
            margin: 1rem 0;
            font-size: 0.9rem;
            color: #64748b;
        }

        .coordinates {
            font-family: 'Courier New', monospace;
            background: #e2e8f0;
            padding: 0.5rem;
            border-radius: 8px;
            margin: 0.5rem 0;
        }

        .btn {
            background: #4f46e5;
            color: white;
            border: none;
            padding: 1rem 2rem;
            border-radius: 12px;
            font-size: 1.1rem;
            cursor: pointer;
            transition: all 0.3s ease;
            margin: 0.5rem;
            min-width: 120px;
        }

        .btn:hover {
            background: #4338ca;
            transform: translateY(-2px);
        }

        .btn:disabled {
            background: #94a3b8;
            cursor: not-allowed;
            transform: none;
        }

        .btn-success {
            background: #10b981;
        }

        .btn-success:hover {
            background: #059669;
        }

        .btn-danger {
            background: #ef4444;
        }

        .btn-danger:hover {
            background: #dc2626;
        }

        .btn-secondary {
            background: #6b7280;
            padding: 0.5rem 1rem;
            font-size: 0.9rem;
        }

        .btn-secondary:hover {
            background: #4b5563;
        }

        .alert {
            padding: 1rem;
            border-radius: 8px;
            margin: 1rem 0;
        }

        .alert-info {
            background: #dbeafe;
            color: #1e40af;
            border-left: 4px solid #3b82f6;
        }

        .alert-success {
            background: #dcfce7;
            color: #166534;
            border-left: 4px solid #22c55e;
        }

        .alert-error {
            background: #fee2e2;
            color: #991b1b;
            border-left: 4px solid #ef4444;
        }

        .loading {
            display: inline-block;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .history {
            text-align: left;
            margin-top: 2rem;
        }

        .history-item {
            background: #f1f5f9;
            padding: 1rem;
            border-radius: 8px;
            margin: 0.5rem 0;
        }

        .history-user {
            font-weight: 600;
            color: #4f46e5;
            margin-bottom: 0.25rem;
        }

        .history-details {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .time {
            font-size: 0.8rem;
            color: #64748b;
        }

        .install-prompt {
            background: #fef3c7;
            color: #92400e;
            padding: 1rem;
            border-radius: 8px;
            margin: 1rem 0;
            border-left: 4px solid #f59e0b;
        }

        .hidden {
            display: none !important;
        }

        .fade-in {
            animation: fadeIn 0.5s ease-in;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .webhook-data {
            background: #f8f9fa;
            border: 1px solid #e9ecef;
            border-radius: 8px;
            padding: 1rem;
            margin: 1rem 0;
            font-family: 'Courier New', monospace;
            font-size: 0.85rem;
            text-align: left;
            max-height: 200px;
            overflow-y: auto;
        }

        @media (max-width: 480px) {
            .container {
                padding: 1.5rem;
                margin: 1rem;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- ‡∏´‡∏ô‡πâ‡∏≤‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö -->
        <div id="loginPage" class="fade-in">
            <h1>üîê ‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö</h1>
            
            <form id="loginForm">
                <div class="form-group">
                    <label for="employeeId">‡∏£‡∏´‡∏±‡∏™‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô</label>
                    <input type="text" id="employeeId" placeholder="‡∏Å‡∏£‡∏≠‡∏Å‡∏£‡∏´‡∏±‡∏™‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô" required>
                </div>
                
                <div class="form-group">
                    <label for="passcode">‡∏£‡∏´‡∏±‡∏™‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô (‡∏ß‡∏±‡∏ô‡πÄ‡∏î‡∏∑‡∏≠‡∏ô‡∏õ‡∏µ‡πÄ‡∏Å‡∏¥‡∏î)</label>
                    <input type="password" id="passcode" placeholder="‡πÄ‡∏ä‡πà‡∏ô 150167 (15 ‡∏°.‡∏Ñ. 67)" required>
                </div>
                
                <div id="loginError" class="alert alert-error hidden">
                    ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏´‡πâ‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á
                </div>
                
                <button type="submit" class="btn">
                    <span id="loginLoading" class="loading" style="display:none;">‚è≥</span>
                    ‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö
                </button>
            </form>
        </div>

        <!-- ‡∏´‡∏ô‡πâ‡∏≤‡πÅ‡∏≠‡∏õ‡∏´‡∏•‡∏±‡∏Å -->
        <div id="mainApp" class="hidden fade-in">
            <div class="user-info">
                <div><strong>üë§ ‡∏£‡∏´‡∏±‡∏™‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô:</strong> <span id="displayId"></span></div>
                <button id="logoutBtn" class="btn btn-secondary" style="margin-top: 0.5rem;">
                    ‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡∏£‡∏∞‡∏ö‡∏ö
                </button>
            </div>

            <h1>üìç Employee Check-in</h1>
            
            <div id="locationStatus" class="alert alert-info">
                ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏Ç‡∏≠‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå‡πÄ‡∏Ç‡πâ‡∏≤‡∏ñ‡∏∂‡∏á‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á...
            </div>

            <div class="status-card">
                <h3>‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô</h3>
                <div id="currentStatus">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡πÄ‡∏ä‡πá‡∏Ñ‡∏≠‡∏¥‡∏ô</div>
                <div class="location-info">
                    <div id="locationInfo">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏´‡∏≤‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á...</div>
                    <div id="coordinates" class="coordinates" style="display:none;"></div>
                </div>
            </div>

            <div>
                <button id="checkinBtn" class="btn btn-success" onclick="checkIn()" disabled>
                    <span class="loading" style="display:none;">‚è≥</span>
                    ‡πÄ‡∏ä‡πá‡∏Ñ‡∏≠‡∏¥‡∏ô
                </button>
                <button id="checkoutBtn" class="btn btn-danger" onclick="checkOut(); console.log('‡∏Ñ‡∏•‡∏¥‡∏Å‡∏õ‡∏∏‡πà‡∏° checkout');" disabled>
                    <span class="loading" style="display:none;">‚è≥</span>
                    ‡πÄ‡∏ä‡πá‡∏Ñ‡πÄ‡∏≠‡∏≤‡∏ï‡πå
                </button>
                
                <!-- ‡∏õ‡∏∏‡πà‡∏°‡∏ó‡∏î‡∏™‡∏≠‡∏ö (‡∏à‡∏∞‡∏•‡∏ö‡∏ó‡∏¥‡πâ‡∏á‡∏´‡∏•‡∏±‡∏á‡πÅ‡∏Å‡πâ‡πÄ‡∏™‡∏£‡πá‡∏à) -->
                <button class="btn btn-secondary" onclick="forceCheckout()" style="margin-top: 10px; font-size: 0.8rem;">
                    üîß Force Checkout (‡∏ó‡∏î‡∏™‡∏≠‡∏ö)
                </button>
            </div>

            <div id="installPrompt" class="install-prompt" style="display:none;">
                üì± <strong>‡∏ï‡∏¥‡∏î‡∏ï‡∏±‡πâ‡∏á‡πÅ‡∏≠‡∏õ‡∏ô‡∏µ‡πâ‡∏ö‡∏ô‡∏≠‡∏∏‡∏õ‡∏Å‡∏£‡∏ì‡πå‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì</strong> ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏Å‡∏≤‡∏£‡πÄ‡∏Ç‡πâ‡∏≤‡∏ñ‡∏∂‡∏á‡∏ó‡∏µ‡πà‡∏£‡∏ß‡∏î‡πÄ‡∏£‡πá‡∏ß!
                <br><button id="installBtn" class="btn" style="margin-top: 0.5rem;">‡∏ï‡∏¥‡∏î‡∏ï‡∏±‡πâ‡∏á</button>
            </div>

            <div class="history">
                <h3>‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏Å‡∏≤‡∏£‡πÄ‡∏ä‡πá‡∏Ñ‡∏≠‡∏¥‡∏ô</h3>
                <div id="historyList"></div>
            </div>

            <!-- ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö Webhook -->
            <details style="margin-top: 2rem;">
                <summary style="cursor: pointer; color: #4f46e5; font-weight: 600;">üì° ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• Webhook (‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö n8n)</summary>
                <div class="webhook-data" id="webhookData">
                    ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏à‡∏∞‡πÅ‡∏™‡∏î‡∏á‡∏´‡∏•‡∏±‡∏á‡∏à‡∏≤‡∏Å‡πÄ‡∏ä‡πá‡∏Ñ‡∏≠‡∏¥‡∏ô/‡πÄ‡∏ä‡πá‡∏Ñ‡πÄ‡∏≠‡∏≤‡∏ï‡πå
                </div>
            </details>
        </div>
    </div>

    <script>
        let currentPosition = null;
        let isCheckedIn = false;
        let deferredPrompt = null;
        let currentUser = null;

        // ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô
        document.addEventListener('DOMContentLoaded', function() {
            checkExistingLogin();
            setupLoginForm();
        });

        // ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏ß‡πà‡∏≤‡∏°‡∏µ‡∏Å‡∏≤‡∏£‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö‡∏≠‡∏¢‡∏π‡πà‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà
        function checkExistingLogin() {
            const savedUser = localStorage.getItem('currentUser');
            if (savedUser) {
                currentUser = JSON.parse(savedUser);
                showMainApp();
            }
        }

        // ‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡∏ü‡∏≠‡∏£‡πå‡∏°‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö
        function setupLoginForm() {
            document.getElementById('loginForm').addEventListener('submit', function(e) {
                e.preventDefault();
                handleLogin();
            });

            document.getElementById('logoutBtn').addEventListener('click', function() {
                logout();
            });

            // ‡∏£‡∏´‡∏±‡∏™‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏£‡∏±‡∏ö‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡∏ï‡∏±‡∏ß‡πÄ‡∏•‡∏Ç
            document.getElementById('passcode').addEventListener('input', function(e) {
                e.target.value = e.target.value.replace(/[^0-9]/g, '');
            });
        }

        // ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö
        function handleLogin() {
            const employeeId = document.getElementById('employeeId').value.trim();
            const passcode = document.getElementById('passcode').value.trim();
            
            const loginBtn = document.querySelector('#loginForm button');
            const loadingSpan = document.getElementById('loginLoading');
            const errorDiv = document.getElementById('loginError');

            // ‡∏ã‡πà‡∏≠‡∏ô‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î
            errorDiv.classList.add('hidden');

            // ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•
            if (!employeeId || !passcode) {
                showLoginError('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏´‡πâ‡∏Ñ‡∏£‡∏ö‡∏ñ‡πâ‡∏ß‡∏ô');
                return;
            }

            if (passcode.length < 5) {
                showLoginError('‡∏£‡∏´‡∏±‡∏™‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏ï‡πâ‡∏≠‡∏á‡∏°‡∏µ‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏ô‡πâ‡∏≠‡∏¢ 5 ‡∏´‡∏•‡∏±‡∏Å');
                return;
            }

            // ‡πÅ‡∏™‡∏î‡∏á loading
            loginBtn.disabled = true;
            loadingSpan.style.display = 'inline-block';

            // ‡∏à‡∏≥‡∏•‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö (‡πÑ‡∏°‡πà‡πÄ‡∏ä‡πá‡∏Ñ‡∏£‡∏´‡∏±‡∏™‡∏à‡∏£‡∏¥‡∏á ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÉ‡∏´‡πâ‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô‡πÑ‡∏î‡πâ‡∏ó‡∏∏‡∏Å‡∏£‡∏´‡∏±‡∏™)
            setTimeout(() => {
                currentUser = {
                    employeeId: employeeId,
                    passcode: passcode,
                    loginTime: new Date().toISOString()
                };

                // ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ
                localStorage.setItem('currentUser', JSON.stringify(currentUser));
                
                // ‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡πÅ‡∏≠‡∏õ‡∏´‡∏•‡∏±‡∏Å
                showMainApp();
                
                loginBtn.disabled = false;
                loadingSpan.style.display = 'none';
            }, 1000);
        }

        // ‡πÅ‡∏™‡∏î‡∏á‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡∏Å‡∏≤‡∏£‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö
        function showLoginError(message) {
            const errorDiv = document.getElementById('loginError');
            errorDiv.textContent = message;
            errorDiv.classList.remove('hidden');
        }

        // ‡πÅ‡∏™‡∏î‡∏á‡πÅ‡∏≠‡∏õ‡∏´‡∏•‡∏±‡∏Å
        function showMainApp() {
            document.getElementById('loginPage').classList.add('hidden');
            document.getElementById('mainApp').classList.remove('hidden');
            
            // ‡πÅ‡∏™‡∏î‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ
            document.getElementById('displayId').textContent = currentUser.employeeId;
            
            // ‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô‡∏£‡∏∞‡∏ö‡∏ö GPS
            checkLocationPermission();
            loadHistory();
            loadStatus();
        }

        // ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡∏£‡∏∞‡∏ö‡∏ö
        function logout() {
            if (confirm('‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡∏£‡∏∞‡∏ö‡∏ö‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà?')) {
                localStorage.removeItem('currentUser');
                localStorage.removeItem('checkedIn');
                localStorage.removeItem('checkinTime');
                currentUser = null;
                
                document.getElementById('mainApp').classList.add('hidden');
                document.getElementById('loginPage').classList.remove('hidden');
                
                // ‡∏£‡∏µ‡πÄ‡∏ã‡πá‡∏ï‡∏ü‡∏≠‡∏£‡πå‡∏°
                document.getElementById('loginForm').reset();
            }
        }

        // ‡∏Ç‡∏≠‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå‡πÄ‡∏Ç‡πâ‡∏≤‡∏ñ‡∏∂‡∏á‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á
        function checkLocationPermission() {
            if (!navigator.geolocation) {
                showAlert('error', '‡∏≠‡∏∏‡∏õ‡∏Å‡∏£‡∏ì‡πå‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì‡πÑ‡∏°‡πà‡∏£‡∏≠‡∏á‡∏£‡∏±‡∏ö GPS');
                return;
            }

            showAlert('info', '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏Ç‡∏≠‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå‡πÄ‡∏Ç‡πâ‡∏≤‡∏ñ‡∏∂‡∏á‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á...');
            
            navigator.geolocation.getCurrentPosition(
                function(position) {
                    currentPosition = position;
                    showAlert('success', '‡πÑ‡∏î‡πâ‡∏£‡∏±‡∏ö‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå‡πÄ‡∏Ç‡πâ‡∏≤‡∏ñ‡∏∂‡∏á‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á‡πÅ‡∏•‡πâ‡∏ß ‚úÖ');
                    updateLocationInfo(position);
                    enableButtons();
                },
                function(error) {
                    let message = '‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÄ‡∏Ç‡πâ‡∏≤‡∏ñ‡∏∂‡∏á‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á‡πÑ‡∏î‡πâ';
                    switch(error.code) {
                        case error.PERMISSION_DENIED:
                            message = '‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡∏õ‡∏è‡∏¥‡πÄ‡∏™‡∏ò‡∏Å‡∏≤‡∏£‡πÄ‡∏Ç‡πâ‡∏≤‡∏ñ‡∏∂‡∏á‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á';
                            break;
                        case error.POSITION_UNAVAILABLE:
                            message = '‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏´‡∏≤‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á‡πÑ‡∏î‡πâ';
                            break;
                        case error.TIMEOUT:
                            message = '‡∏´‡∏°‡∏î‡πÄ‡∏ß‡∏•‡∏≤‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏´‡∏≤‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á';
                            break;
                    }
                    showAlert('error', message);
                },
                {
                    enableHighAccuracy: true,
                    timeout: 10000,
                    maximumAge: 300000
                }
            );
        }

        // ‡∏≠‡∏±‡∏û‡πÄ‡∏î‡∏ó‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á
        function updateLocationInfo(position) {
            const lat = position.coords.latitude.toFixed(6);
            const lng = position.coords.longitude.toFixed(6);
            const accuracy = Math.round(position.coords.accuracy);
            
            document.getElementById('locationInfo').innerHTML = 
                `üìç ‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô (‡∏Ñ‡∏ß‡∏≤‡∏°‡πÅ‡∏°‡πà‡∏ô‡∏¢‡∏≥: ${accuracy}m)`;
            document.getElementById('coordinates').innerHTML = 
                `${lat}, ${lng}`;
            document.getElementById('coordinates').style.display = 'block';
        }

        // ‡πÄ‡∏õ‡∏¥‡∏î‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô‡∏õ‡∏∏‡πà‡∏°
        function enableButtons() {
            document.getElementById('checkinBtn').disabled = false;
            document.getElementById('checkoutBtn').disabled = false;
        }

        // ‡πÅ‡∏™‡∏î‡∏á‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô
        function showAlert(type, message) {
            const alertDiv = document.getElementById('locationStatus');
            alertDiv.className = `alert alert-${type}`;
            alertDiv.innerHTML = message;
        }

        // ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡πÄ‡∏ä‡πá‡∏Ñ‡∏≠‡∏¥‡∏ô
        function checkIn() {
            if (!currentPosition) {
                showAlert('error', '‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏≠‡∏ô‡∏∏‡∏ç‡∏≤‡∏ï‡∏Å‡∏≤‡∏£‡πÄ‡∏Ç‡πâ‡∏≤‡∏ñ‡∏∂‡∏á‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á‡∏Å‡πà‡∏≠‡∏ô');
                return;
            }

            const btn = document.getElementById('checkinBtn');
            btn.disabled = true;
            btn.querySelector('.loading').style.display = 'inline-block';

            // ‡∏≠‡∏±‡∏û‡πÄ‡∏î‡∏ó‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á‡πÉ‡∏´‡∏°‡πà
            navigator.geolocation.getCurrentPosition(
                function(position) {
                    currentPosition = position;
                    const now = new Date();
                    const record = {
                        action: 'checkin',
                        employeeId: currentUser.employeeId,
                        passcode: currentUser.passcode,
                        timestamp: now.toISOString(),
                        datetime: now.toLocaleString('th-TH'),
                        location: {
                            latitude: position.coords.latitude,
                            longitude: position.coords.longitude,
                            accuracy: Math.round(position.coords.accuracy)
                        }
                    };

                    // ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡πÅ‡∏•‡∏∞ webhook data
                    saveToHistory(record);
                    updateWebhookData(record);
                    
                    // ‡∏™‡πà‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏õ n8n
                    sendToN8N(record);
                    
                    // ‡∏™‡πà‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏õ n8n
                    sendToN8N(record);
                    
                    // ‡∏≠‡∏±‡∏û‡πÄ‡∏î‡∏ó‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞
                    isCheckedIn = true;
                    localStorage.setItem('checkedIn', 'true');
                    localStorage.setItem('checkinTime', now.toISOString());
                    localStorage.setItem('checkinUser', currentUser.employeeId);
                    
                    updateStatus();
                    showAlert('success', `‚úÖ ‡∏£‡∏´‡∏±‡∏™ ${currentUser.employeeId} ‡πÄ‡∏ä‡πá‡∏Ñ‡∏≠‡∏¥‡∏ô‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à!`);
                    
                    btn.disabled = false;
                    btn.querySelector('.loading').style.display = 'none';
                },
                function(error) {
                    showAlert('error', '‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏£‡∏±‡∏ö‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á‡πÑ‡∏î‡πâ ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏•‡∏≠‡∏á‡πÉ‡∏´‡∏°‡πà');
                    btn.disabled = false;
                    btn.querySelector('.loading').style.display = 'none';
                }
            );
        }

        // ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡πÄ‡∏ä‡πá‡∏Ñ‡πÄ‡∏≠‡∏≤‡∏ï‡πå
        function checkOut() {
            // ‡πÄ‡∏ä‡πá‡∏Ñ‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡πÉ‡∏´‡∏°‡πà‡∏ó‡∏∏‡∏Å‡∏Ñ‡∏£‡∏±‡πâ‡∏á
            const currentCheckedIn = localStorage.getItem('checkedIn') === 'true';
            const checkinUser = localStorage.getItem('checkinUser');
            
            if (!currentCheckedIn || checkinUser !== currentUser.employeeId) {
                showAlert('error', '‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏ä‡πá‡∏Ñ‡∏≠‡∏¥‡∏ô‡∏Å‡πà‡∏≠‡∏ô');
                return;
            }
            
            // ‡∏£‡∏µ‡πÄ‡∏ã‡πá‡∏ï isProcessing ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö checkout
            if (isProcessing) {
                console.log('‡∏£‡∏µ‡πÄ‡∏ã‡πá‡∏ï processing ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö checkout');
                isProcessing = false;
            }

            const btn = document.getElementById('checkoutBtn');
            btn.disabled = true;
            btn.querySelector('.loading').style.display = 'inline-block';

            navigator.geolocation.getCurrentPosition(
                function(position) {
                    currentPosition = position;
                    const now = new Date();
                    const record = {
                        action: 'checkout',
                        employeeId: currentUser.employeeId,
                        passcode: currentUser.passcode,
                        timestamp: now.toISOString(),
                        datetime: now.toLocaleString('th-TH'),
                        location: {
                            latitude: position.coords.latitude,
                            longitude: position.coords.longitude,
                            accuracy: Math.round(position.coords.accuracy)
                        }
                    };

                    // ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡πÅ‡∏•‡∏∞ webhook data
                    saveToHistory(record);
                    updateWebhookData(record);
                    
                    // ‡∏≠‡∏±‡∏û‡πÄ‡∏î‡∏ó‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞
                    isCheckedIn = false;
                    localStorage.setItem('checkedIn', 'false');
                    localStorage.removeItem('checkinTime');
                    localStorage.removeItem('checkinUser');
                    
                    updateStatus();
                    showAlert('success', `‚úÖ ‡∏£‡∏´‡∏±‡∏™ ${currentUser.employeeId} ‡πÄ‡∏ä‡πá‡∏Ñ‡πÄ‡∏≠‡∏≤‡∏ï‡πå‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à!`);
                    
                    btn.disabled = false;
                    btn.querySelector('.loading').style.display = 'none';
                },
                function(error) {
                    showAlert('error', '‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏£‡∏±‡∏ö‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á‡πÑ‡∏î‡πâ ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏•‡∏≠‡∏á‡πÉ‡∏´‡∏°‡πà');
                    btn.disabled = false;
                    btn.querySelector('.loading').style.display = 'none';
                }
            );
        }

        // ‡∏≠‡∏±‡∏û‡πÄ‡∏î‡∏ó‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• webhook
        function updateWebhookData(record) {
            const webhookDiv = document.getElementById('webhookData');
            webhookDiv.innerHTML = `<strong>‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î:</strong>
${JSON.stringify(record, null, 2)}

<strong>URL ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö webhook:</strong>
GET: ${window.location.origin}${window.location.pathname}?data=latest
POST: ‡∏™‡πà‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏õ‡∏¢‡∏±‡∏á n8n webhook endpoint`;
            
            // ‡πÄ‡∏Å‡πá‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö webhook
            localStorage.setItem('latestWebhookData', JSON.stringify(record));
        }

        // ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥
        function saveToHistory(record) {
            let history = JSON.parse(localStorage.getItem('checkinHistory') || '[]');
            history.unshift(record); // ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ó‡∏µ‡πà‡∏î‡πâ‡∏≤‡∏ô‡∏ö‡∏ô
            if (history.length > 100) history.pop(); // ‡πÄ‡∏Å‡πá‡∏ö‡πÑ‡∏ß‡πâ‡πÅ‡∏Ñ‡πà 100 ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£
            localStorage.setItem('checkinHistory', JSON.stringify(history));
            loadHistory();
        }

        // ‡πÇ‡∏´‡∏•‡∏î‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥
        function loadHistory() {
            const history = JSON.parse(localStorage.getItem('checkinHistory') || '[]');
            const historyDiv = document.getElementById('historyList');
            
            // ‡πÅ‡∏™‡∏î‡∏á‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏Ç‡∏≠‡∏á‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô
            const userHistory = currentUser ? history.filter(record => record.employeeId === currentUser.employeeId) : history;
            
            if (userHistory.length === 0) {
                historyDiv.innerHTML = '<div class="history-item">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥</div>';
                return;
            }

            historyDiv.innerHTML = userHistory.slice(0, 10).map(record => `
                <div class="history-item">
                    <div class="history-user">üë§ ${record.employeeId}</div>
                    <div class="history-details">
                        <div>
                            <strong>${record.action === 'checkin' ? '‡πÄ‡∏ä‡πá‡∏Ñ‡∏≠‡∏¥‡∏ô' : '‡πÄ‡∏ä‡πá‡∏Ñ‡πÄ‡∏≠‡∏≤‡∏ï‡πå'}</strong>
                            <div class="time">${record.datetime}</div>
                        </div>
                        <div class="time">
                            üìç ${record.location.latitude.toFixed(4)}, ${record.location.longitude.toFixed(4)}
                        </div>
                    </div>
                </div>
            `).join('');
        }

        // ‡πÇ‡∏´‡∏•‡∏î‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞
        function loadStatus() {
            if (currentUser) {
                const storedStatus = localStorage.getItem('checkedIn');
                const storedUser = localStorage.getItem('checkinUser');
                
                // ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏ß‡πà‡∏≤‡πÄ‡∏õ‡πá‡∏ô‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡∏Ñ‡∏ô‡πÄ‡∏î‡∏µ‡∏¢‡∏ß‡∏Å‡∏±‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏ä‡πá‡∏Ñ‡∏≠‡∏¥‡∏ô
                if (storedStatus === 'true' && storedUser === currentUser.employeeId) {
                    isCheckedIn = true;
                } else {
                    isCheckedIn = false;
                    localStorage.setItem('checkedIn', 'false');
                }
                updateStatus();
            }
        }

        // ‡∏≠‡∏±‡∏û‡πÄ‡∏î‡∏ó‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞
        function updateStatus() {
            const statusDiv = document.getElementById('currentStatus');
            if (isCheckedIn) {
                const checkinTime = localStorage.getItem('checkinTime');
                if (checkinTime) {
                    const time = new Date(checkinTime).toLocaleString('th-TH');
                    statusDiv.innerHTML = `‚úÖ ‡πÄ‡∏ä‡πá‡∏Ñ‡∏≠‡∏¥‡∏ô‡πÅ‡∏•‡πâ‡∏ß<br><small>‡πÄ‡∏ß‡∏•‡∏≤: ${time}</small>`;
                } else {
                    statusDiv.innerHTML = '‚úÖ ‡πÄ‡∏ä‡πá‡∏Ñ‡∏≠‡∏¥‡∏ô‡πÅ‡∏•‡πâ‡∏ß';
                }
            } else {
                statusDiv.innerHTML = '‚ùå ‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡πÄ‡∏ä‡πá‡∏Ñ‡∏≠‡∏¥‡∏ô';
            }
        }

        // PWA Installation
        window.addEventListener('beforeinstallprompt', (e) => {
            e.preventDefault();
            deferredPrompt = e;
            if (document.getElementById('mainApp').classList.contains('hidden') === false) {
                document.getElementById('installPrompt').style.display = 'block';
            }
        });

        document.getElementById('installBtn').addEventListener('click', async () => {
            if (!deferredPrompt) return;
            
            deferredPrompt.prompt();
            const { outcome } = await deferredPrompt.userChoice;
            
            if (outcome === 'accepted') {
                document.getElementById('installPrompt').style.display = 'none';
            }
            
            deferredPrompt = null;
        });

        // ‡∏ã‡πà‡∏≠‡∏ô‡∏õ‡∏∏‡πà‡∏°‡∏ï‡∏¥‡∏î‡∏ï‡∏±‡πâ‡∏á‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏ï‡∏¥‡∏î‡∏ï‡∏±‡πâ‡∏á‡πÅ‡∏•‡πâ‡∏ß
        window.addEventListener('appinstalled', () => {
            document.getElementById('installPrompt').style.display = 'none';
        });

        // API ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö webhook (‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏ï‡∏¥‡∏°)
        window.getLatestData = function() {
            return JSON.parse(localStorage.getItem('latestWebhookData') || 'null');
        };

        window.getAllHistory = function() {
            return JSON.parse(localStorage.getItem('checkinHistory') || '[]');
        };

        // ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏™‡πà‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏õ n8n - ‡πÄ‡∏ß‡∏≠‡∏£‡πå‡∏ä‡∏±‡πà‡∏ô‡∏á‡πà‡∏≤‡∏¢
        function sendToN8N(data) {
            const webhookUrl = 'https://vizhvian.app.n8n.cloud/webhook-test/955a2d77-64d6-4c9f-b652-2eef8007dc6f';
            
            // ‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏´‡πâ‡∏Ñ‡∏£‡∏ö‡∏ñ‡πâ‡∏ß‡∏ô
            const completeData = {
                action: data.action,
                employeeId: data.employeeId,
                passcode: data.passcode,
                timestamp: data.timestamp,
                datetime: data.datetime,
                location: data.location,
                // ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏≥‡∏£‡∏≠‡∏á
                lat: data.location.latitude,
                lng: data.location.longitude,
                accuracy: data.location.accuracy,
                user_id: data.employeeId,
                user_code: data.passcode,
                check_type: data.action,
                check_time: data.timestamp,
                check_datetime: data.datetime,
                unique_id: `${data.employeeId}_${data.action}_${Date.now()}`
            };
            
            // ‡∏™‡πà‡∏á‡πÅ‡∏ö‡∏ö‡∏õ‡∏Å‡∏ï‡∏¥‡∏Å‡πà‡∏≠‡∏ô
            fetch(webhookUrl, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify(completeData)
            })
            .then(response => {
                if (response.ok) {
                    console.log('‡∏™‡πà‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏õ n8n ‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à (‡πÇ‡∏´‡∏°‡∏î‡∏õ‡∏Å‡∏ï‡∏¥)');
                } else {
                    throw new Error('Response not ok');
                }
            })
            .catch(error => {
                console.log('‡∏•‡∏≠‡∏á‡∏™‡πà‡∏á‡πÅ‡∏ö‡∏ö no-cors...');
                
                // ‡∏´‡∏≤‡∏Å‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ ‡∏•‡∏≠‡∏á‡πÅ‡∏ö‡∏ö no-cors
                fetch(webhookUrl, {
                    method: 'POST',
                    mode: 'no-cors',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(completeData)
                })
                .then(() => {
                    console.log('‡∏™‡πà‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏õ n8n ‡πÅ‡∏•‡πâ‡∏ß (no-cors mode)');
                })
                .catch(err => {
                    console.error('‡∏™‡πà‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ:', err);
                });
            });
        }
    </script>
</body>
</html>